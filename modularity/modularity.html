

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Modularity - Basics &#8212; Lab Programming Workshop</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'modularity/modularity';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Example: Miniscope IO" href="miniscope_io_refactoring.html" />
    <link rel="prev" title="Modularity" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Intro
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../packaging.html">Packaging</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Modularity</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Modularity - Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="miniscope_io_refactoring.html">Example: Miniscope IO</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../docs.html">Docs</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tests/index.html">Tests</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tests/tests.html">Testing - Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tests/testable_code.html">Writing Testable Code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../collaboration.html">Collaboration</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Meta</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../seealso.html">See Also</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/sneakers-the-rat/lab-programming-workshop" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/sneakers-the-rat/lab-programming-workshop/issues/new?title=Issue%20on%20page%20%2Fmodularity/modularity.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/modularity/modularity.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Modularity - Basics</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interfaces-and-implementation">Interfaces and Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-from-pvp">Example from PVP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#functions">Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#worked-example">Worked Example</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#separate-i-o-from-analysis">Separate I/O from analysis</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#generalize-repeated-operations">Generalize Repeated Operations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#classes">Classes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inheritance">Inheritance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#abstract-methods">Abstract Methods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#types-and-type-hints">Types and Type Hints</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#on-notebooks">On Notebooks…</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="modularity-basics">
<h1>Modularity - Basics<a class="headerlink" href="#modularity-basics" title="Permalink to this heading">#</a></h1>
<p>The essence of modularity is to write code that never does or depends on anything <em>implicitly.</em></p>
<section id="interfaces-and-implementation">
<h2>Interfaces and Implementation<a class="headerlink" href="#interfaces-and-implementation" title="Permalink to this heading">#</a></h2>
<p>Separate <em>interfaces</em> from <em>implementation</em> - Things should have a well defined means of interacting with them that should
remain relatively stable. They can then rely on <em>private</em> functions or methods that are not supposed to be called from other
code. This is the notion of <em>information hiding</em> (and when it fails, information leakage). The simplest notion of an
interface is a function signature (the arguments that it accepts), but as we get into more complicated examples we’ll
see different types of interfaces. Interfaces, abstractly, are the places where you mark of what one piece of code should do — and
thus what it should <em>not</em> do — and how other things should make it do those things.</p>
<section id="example-from-pvp">
<h3>Example from PVP<a class="headerlink" href="#example-from-pvp" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://www.peoplesvent.org/en/latest/software/software_overview.html">Software Overview</a></p></li>
<li><p><a class="reference external" href="https://www.peoplesvent.org/en/latest/software/gui/index.html">GUI</a></p></li>
</ul>
<p><img alt="Software overview diagram for the people's ventilator project" src="../_images/pvp_software_overview-01.png" /></p>
<p>We have defined not only the individual components of the system, but also <em>how they are allowed to communicate</em>. By
carefully limiting how much each other part of the system “knows” about the others, we make sure that changes don’t
cascade from one part of the system to the others. The types “sensor values” and “control settings” are well defined, and
we have written tests that ensure each of the modules can still handle each of the basic types.</p>
<p>For example, the Alarm system emits an <code class="docutils literal notranslate"><span class="pre">Alarm</span></code> type that explicitly defines what properties it should have and
raise an error if they aren’t present:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pvp.alarm</span> <span class="kn">import</span> <span class="n">AlarmType</span><span class="p">,</span> <span class="n">AlarmSeverity</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Alarm</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Representation of alarm status and parameters</span>
<span class="sd">    Parameterized by a :class:`Alarm_Rule` and managed by :class:`Alarm_Manager`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">alarm_type</span><span class="p">:</span> <span class="n">AlarmType</span><span class="p">,</span>
                 <span class="n">severity</span><span class="p">:</span> <span class="n">AlarmSeverity</span><span class="p">,</span>
                 <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            alarm_type ( :class:`.AlarmType` ): Type of alarm</span>
<span class="sd">            severity ( :class:`.AlarmSeverity` ) : Severity of alarm</span>
<span class="sd">            start_time (float): Timestamp of alarm start, (as generated by ``time.time()``</span>
<span class="sd">        Attributes:</span>
<span class="sd">            id (int): unique alarm ID</span>
<span class="sd">            end_time (None, float): If None, alarm has not ended. otherwise timestamp</span>
<span class="sd">            active (bool): Whether or not the alarm is currently active</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="n">AlarmSeverity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_severity</span> <span class="o">=</span> <span class="n">severity</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alarm_type</span><span class="p">,</span> <span class="n">AlarmType</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alarm_type</span> <span class="o">=</span> <span class="n">alarm_type</span>

        <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
</pre></div>
</div>
<p>It doesn’t matter to the GUI how the alarm manager creates the alarm description, and it doesn’t matter to the alarm
manager how the GUI uses the Alarm, but they interact using the Alarm object as an <em>interface</em><a class="footnote-reference brackets" href="#interface" id="id1">1</a></p>
</section>
</section>
<section id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this heading">#</a></h2>
<p>Some basic principles for writing modular functions:</p>
<ul class="simple">
<li><p>Every function should do <strong>one thing</strong>, and that <strong>one thing</strong> should be as specific as possible. Rather than a function
called “<code class="docutils literal notranslate"><span class="pre">analyze_data</span></code>,” write 20 functions that are each like “<code class="docutils literal notranslate"><span class="pre">sort_trials</span></code>,” “<code class="docutils literal notranslate"><span class="pre">count_spikes</span></code>,” etc.</p></li>
<li><p>A corrolary is that functions should be <strong>short</strong> - think &lt; 30 lines or so (though this is not hard or fast at all)</p></li>
<li><p>Never rely on <strong>global workspace variables</strong> or the <strong>working directory</strong>. Your function should take as arguments
everything that it needs to know, and return everything that it has done — or in the case of functions that write
data to disk (and so don’t return anything) return some status code that the file write was successful or not.</p></li>
<li><p><strong>Avoid nested loops</strong> inside a single function. Instead encapsulate the logic of a single operation and then, if needed,
wrap it in another function that can call it multiple times.</p></li>
<li><p>Write <strong>one function</strong> to do <strong>one operation</strong> – rather than a family of functions that each do a slightly different version
of the same task, make the function able to have different functionality with optional arguments. If that’s impossible,
it’s a sign that a deeper refactoring is needed. If you have a dozen different ways of loading similar data, you’ll
need a dozen different packages to analyze it!</p></li>
</ul>
<section id="worked-example">
<h3>Worked Example<a class="headerlink" href="#worked-example" title="Permalink to this heading">#</a></h3>
<p>How can we refactor this function for extracting deeplabcut points out to be more flexible?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">getmidpoint</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">midpoint</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pt1</span><span class="o">+</span><span class="n">pt2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">midpoint</span>

<span class="k">def</span> <span class="nf">extract_points</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">bodyparts</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">pix2cm</span><span class="o">=</span><span class="mf">15.8</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.7</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    function to extract mouse and cricket xy positions from DLC output csv</span>
<span class="sd">    will also get the likelihood values for cricket positions</span>
<span class="sd">    can be adapted later to add extraction of likelihood for the mouse</span>
<span class="sd">    Args:</span>
<span class="sd">        file (str): filename/ path to the DLC output</span>
<span class="sd">        bodyparts (list): list of the bodypart labels from DLC you need</span>
<span class="sd">            added as an input since names vary across models</span>
<span class="sd">        fr (int): framerate of videos, default=200</span>
<span class="sd">        pix2cm (int): conversion from pixels to cm, default=15.8 (needs to be checked)</span>
<span class="sd">        thresh (int): threshold for likelihood values, default=0.7</span>
<span class="sd">    Returns:</span>
<span class="sd">        mouse_xy (:class:`numpy.ndarray`): xy coordinates for the mouse across the trial</span>
<span class="sd">        cricket_xy (:class:`numpy.ndarray`): xy coordinates for the cricket across trial, cricket_xy is filtered to remove points with low likelihood</span>
<span class="sd">        cricket_p (:class:`numpy.ndarray`): likelihood values of cricket points</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#set the constant values that will be used throughout</span>
    <span class="c1">#load relevant dlc points from the csv, limits the amount you have to work with</span>
    <span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">bodyparts</span><span class="p">]</span>

    <span class="c1">#create 2d array for mouse xy coordinates</span>
    <span class="c1">#right now indexing df depends on order of your bodyparts lists, find a better way to deal with this</span>
    <span class="n">rear_x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">rear_y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">lear_x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">lear_y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">rear_xy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">rear_x</span><span class="p">,</span><span class="n">rear_y</span><span class="p">])</span>
    <span class="n">lear_xy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">lear_x</span><span class="p">,</span><span class="n">lear_y</span><span class="p">])</span>

    <span class="n">headbase_x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">headbase_y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">headbase_xy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">headbase_x</span><span class="p">,</span><span class="n">headbase_y</span><span class="p">])</span><span class="o">/</span><span class="n">pix2cm</span>


    <span class="n">mouse_xy</span><span class="o">=</span><span class="n">getmidpoint</span><span class="p">(</span><span class="n">rear_xy</span><span class="p">,</span><span class="n">lear_xy</span><span class="p">)</span><span class="o">/</span><span class="n">pix2cm</span>

    <span class="c1">#extract cricket likelihood and xy coordinates, same indexing issue</span>
    <span class="c1">#average function?</span>
    <span class="n">cricket_p</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;likelihood&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s1">&#39;likelihood&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1">#add pvalues to the same array as xy</span>
    <span class="n">cricket_x</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pix2cm</span><span class="p">)</span>
    <span class="n">cricket_y</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="n">bodyparts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pix2cm</span><span class="p">)</span>

    <span class="n">thresh_cricket_x</span><span class="o">=</span><span class="n">cricket_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">thresh_cricket_x</span><span class="p">[</span><span class="n">cricket_p</span><span class="o">&lt;</span><span class="n">thresh</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">thresh_cricket_y</span><span class="o">=</span><span class="n">cricket_y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">thresh_cricket_y</span><span class="p">[</span><span class="n">cricket_p</span><span class="o">&lt;</span><span class="n">thresh</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">cricket_xy</span><span class="o">=</span><span class="p">[</span><span class="n">thresh_cricket_x</span><span class="p">,</span> <span class="n">thresh_cricket_y</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mouse_xy</span><span class="p">,</span> <span class="n">cricket_p</span><span class="p">,</span> <span class="n">cricket_xy</span><span class="p">,</span> <span class="n">rear_xy</span><span class="p">,</span> <span class="n">lear_xy</span><span class="p">,</span> <span class="n">headbase_xy</span>
</pre></div>
</div>
<p>We’ll do two major things now and then revisit this as we learn a bit more about classes and types.</p>
<section id="separate-i-o-from-analysis">
<h4>Separate I/O from analysis<a class="headerlink" href="#separate-i-o-from-analysis" title="Permalink to this heading">#</a></h4>
<p>The first thing we do is load the data using <code class="docutils literal notranslate"><span class="pre">pd.read_csv</span></code> from a path that we are given. Then,
because the data is in a pretty awkward format, we are forced to hardcode a lot of the rest of the function. That’s a problem
because there are a lot of times when we want to use data from DeepLabCut, and is hard to reuse this for a different
project.</p>
<p>We can make the function a bit more general and do ourselves some favors in data formatting by writing a separate
loading function</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="k">def</span> <span class="nf">load_tracks</span><span class="p">(</span><span class="n">file</span><span class="p">:</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load tracks estimated from DLC output in the form of:</span>
<span class="sd">    </span>
<span class="sd">    | scorer      | DLC...      | DLC...  | DLC...     | DLC...      | DLC...  | DLC...     |</span>
<span class="sd">    |-------------|-------------|---------|------------|-------------|---------|------------|</span>
<span class="sd">    | individuals | mouse       | mouse   | mouse      | mouse       | mouse   | mouse      |</span>
<span class="sd">    | bodyparts   | nose        | nose    | nose       | Rear        | Rear    | Rear       |</span>
<span class="sd">    | coords      | x           | y       | likelihood | x           | y       | likelihood |</span>
<span class="sd">    | 0           | 0.995999992 | 1       |            |             |         |            |</span>
<span class="sd">    | 1           | 669.523     | 1       | 298.825    | 0.995000005 |         |            |</span>
<span class="sd">    | 2           | 673.518     | 299.602 | 631.271    |             |         |            |</span>
<span class="sd">    | 3           | 298.639     | 674.286 | 1          | 299.904     | 633.732 | 1          |</span>
<span class="sd">    | 4           | 298.605     | 674.286 | 1          | 299.686     | 633.732 | 1          |</span>
<span class="sd">    </span>
<span class="sd">    To a dictionary of dataframes that each have three columns, ``x``, ``y``, and ``probability``</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        file (:class:`pathlib.Path`): Location of DLC output .csv</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, pandas.DataFrame]: Dataframe for each extracted part</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Skip the first two rows: scorer and animal name</span>
    <span class="c1"># Treat the next two rows as the index: bodypart and x,y,likelihood values</span>
    <span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># make separate dataframes for each bodypart</span>
    <span class="c1"># .columns returns the column indices, which map onto the header we declared above</span>
    <span class="n">bodyparts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">part</span><span class="p">:</span><span class="n">data</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">bodyparts</span>
</pre></div>
</div>
<p>This gives us something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tracks</span> <span class="o">=</span> <span class="n">load_tracks</span><span class="p">(</span><span class="s1">&#39;data/sky_mouse_example.csv&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tracks</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="go">dict_keys([&#39;Lear&#39;, &#39;Rear&#39;, &#39;anteriorC&#39;, &#39;bodyparts&#39;, &#39;headbase&#39;, &#39;nose&#39;, &#39;posteriorC&#39;, &#39;spine&#39;, &#39;tailbase&#39;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tracks</span><span class="p">[</span><span class="s1">&#39;Lear&#39;</span><span class="p">]</span>
<span class="go">            x        y  likelihood</span>
<span class="go">0         NaN      NaN         1.0</span>
<span class="go">1     314.868  636.708         1.0</span>
<span class="go">2     321.200  642.990         NaN</span>
<span class="go">3     324.393  644.676         1.0</span>
<span class="go">4     324.393  644.676         1.0</span>
</pre></div>
</div>
</section>
<section id="generalize-repeated-operations">
<h4>Generalize Repeated Operations<a class="headerlink" href="#generalize-repeated-operations" title="Permalink to this heading">#</a></h4>
<p>The rest of the function</p>
<ul class="simple">
<li><p>extracts out x/y coordinate pairs into n x 2 numpy arrays,</p></li>
<li><p>computes midpoints, for example the center of the mouse’s head from the ear positions</p></li>
<li><p>filters points based on the probability.</p></li>
<li><p>transforms pixels to centimeters</p></li>
</ul>
<p>Those sound like three separate functions to me!</p>
<p>One of those already is its own function (<code class="docutils literal notranslate"><span class="pre">getmidpoint</span></code>), and we can make that just <code class="docutils literal notranslate"><span class="pre">midpoint</span></code> because
the <code class="docutils literal notranslate"><span class="pre">get</span></code> is implicit in it being a function that returns something. Since the conversion to cm is just
multiplication by a scalar, we’ll save that as an example for the Classes section.</p>
<p>(my docstrings are bad here just because I’m in a hurry)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">df_to_xy</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dataframe with `x` and `y` columns from :func:`load_tracks`, </span>
<span class="sd">    return an ``n x 2`` array of x/y coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">probability_thresh</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dataframe with `x` and `y` columns from :func:`load_tracks`, </span>
<span class="sd">    set all coordinates below a thrshold to NaN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;likelihood&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">thresh</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">df</span>

</pre></div>
</div>
<p>Now we can compose these functions to make a nice midpoint function that takes our data and finds midpoints
based off part names</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="k">def</span> <span class="nf">part_midpoints</span><span class="p">(</span><span class="n">df_dict</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">part1</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">part2</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">xy_1</span> <span class="o">=</span> <span class="n">df_to_xy</span><span class="p">(</span><span class="n">df_dict</span><span class="p">[</span><span class="n">part1</span><span class="p">])</span>
    <span class="n">xy_2</span> <span class="o">=</span> <span class="n">df_to_xy</span><span class="p">(</span><span class="n">df_dict</span><span class="p">[</span><span class="n">part2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">getmidpoint</span><span class="p">(</span><span class="n">xy_1</span><span class="p">,</span> <span class="n">xy_2</span><span class="p">)</span>

</pre></div>
</div>
<p>We’ve now split up our function into a few parts that make it so we don’t have to repeat ourselves as
much, so now the part that’s unique to this experiment can look more like this</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="n">data</span> <span class="o">=</span> <span class="n">load_tracks</span><span class="p">(</span><span class="s1">&#39;data/sky_mouse_example.csv&#39;</span><span class="p">)</span>

<span class="c1"># extract mouse things</span>
<span class="n">mouse_xy</span> <span class="o">=</span> <span class="n">part_midpoints</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;Lear&#39;</span><span class="p">,</span> <span class="s1">&#39;Rear&#39;</span><span class="p">)</span>
<span class="n">headbase_xy</span> <span class="o">=</span> <span class="n">df_to_xy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;headbase&#39;</span><span class="p">])</span>
<span class="n">rear_xy</span> <span class="o">=</span> <span class="n">df_to_xy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Rear&#39;</span><span class="p">])</span>
<span class="n">lear_xy</span> <span class="o">=</span> <span class="n">df_to_xy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Lear&#39;</span><span class="p">])</span>

<span class="c1"># extract cricket things</span>
<span class="k">for</span> <span class="n">cricket_part</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;anteriorC&#39;</span><span class="p">,</span> <span class="s1">&#39;posteriorC&#39;</span><span class="p">]:</span>
    <span class="n">data</span><span class="p">[</span><span class="n">cricket_part</span><span class="p">]</span> <span class="o">=</span> <span class="n">probability_thresh</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cricket_part</span><span class="p">],</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">cricket_xy</span> <span class="o">=</span> <span class="n">part_midpoints</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;anteriorC&#39;</span><span class="p">,</span> <span class="s1">&#39;posteriorC&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is still a bit messy because we are creating a large amount of independent variables that are
very similar. We’ll show how to encapsulate that a bit later, to get there let’s talk a bit about clases.</p>
</section>
</section>
</section>
<section id="classes">
<h2>Classes<a class="headerlink" href="#classes" title="Permalink to this heading">#</a></h2>
<p>There’s still plenty of implicitness in the above functions: we specify in our type hints that
we take a pandas DataFrame, and then in the docstring describe what it should consist of, but
we can do better! We can, make a specific class that represents our deeplabcut coordinates!</p>
<p>Classes let us encapsulate related sets of variables (attributes) and functions (methods).</p>
<p>A few more basic principles:</p>
<ul class="simple">
<li><p>Declare all attributes that your object has in <code class="docutils literal notranslate"><span class="pre">__init__</span></code> - you shouldn’t get an object that’s missing an attribute that
you expect it to have.</p></li>
<li><p>Keep splitting up your functions! but you don’t want all of them to be available to the user,
then you have to make sure that they stay mostly consistent over time. Instead, choose which parts
you want to expose as the interface and keep the rest <em>private</em> to indicate that people shouldn’t rely
on those. In python that’s indicated by putting an <code class="docutils literal notranslate"><span class="pre">_underscore()</span></code> below a method name.</p></li>
<li><p>Use <a class="reference external" href="https://docs.python.org/3/library/functions.html?highlight=property#property">properties</a> for <em>static</em> attributes
that are derived from other attributes. For example, if you have a <code class="docutils literal notranslate"><span class="pre">volume</span></code> class that takes in some volume as Liters,
you can define a <code class="docutils literal notranslate"><span class="pre">mL</span></code> property that returns the current volume / 1000.</p></li>
</ul>
<p>For example, we can imagine making a wrapper around some common DeepLabCut data idioms like this
(reusing some of our previous functions just for funzies to show how simple functions let us use them in
a bunch of different places):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">DLCPart</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An individual </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">likelihood</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;likelihood&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_to_xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">)</span>
        

<span class="k">class</span> <span class="nc">DLCData</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parts</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">scorer</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
      
        <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span> <span class="o">=</span> <span class="n">scorer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">DLCPart</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parts</span><span class="o">=</span><span class="n">load_tracks</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">part_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If we don&#39;t have an attribute, see if it&#39;s one of our parts and return that</span>
<span class="sd">        </span>
<span class="sd">        Only called when an attr isn&#39;t found, so we don&#39;t have to handle that case specifically</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># this is actually an attribute error, trivial change</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No attribute or part named </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2"> found&quot;</span><span class="p">)</span>
        
        
</pre></div>
</div>
<p>Here we’re using a <em>composition</em> strategy where one class uses another class as its attributes: the two are defined
independently, but used together. But since we have made an explicit class with specific attributes and methods,
our static analysis tools will tell us if we try to do something impossible with it.</p>
<p>Since we can contain an arbitrary DLC dataset in that object and get all the other representations that
we use in our downstream analysis functions, we no longer <em>need</em> a specific function that has a bunch of
hardcoded variable names, and we can start removing them from our other analysis functions, eg. those in
<a class="reference external" href="https://github.com/wehr-lab/Prey_Capture_Python/blob/main/prey_capture_python/analysis/geometries.py">geometries</a></p>
<p>We can then use this class like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">DLCData</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="s1">&#39;my_data.csv&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">Lear</span><span class="o">.</span><span class="n">xy</span> 
</pre></div>
</div>
<p>which gives an array equivalent to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tracks</span> <span class="o">=</span> <span class="n">load_tracks</span><span class="p">(</span><span class="s1">&#39;data/sky_mouse_example.csv&#39;</span><span class="p">)</span>
<span class="n">lear_xy</span> <span class="o">=</span> <span class="n">df_to_xy</span><span class="p">(</span><span class="n">tracks</span><span class="p">[</span><span class="s1">&#39;Lear&#39;</span><span class="p">])</span>
</pre></div>
</div>
<section id="inheritance">
<h3>Inheritance<a class="headerlink" href="#inheritance" title="Permalink to this heading">#</a></h3>
<p>Inheritance lets you group things together and elaborate their function.</p>
<p>Data -&gt; specific format</p>
<p>Example from autopilot and GPIO classes and then registry</p>
</section>
<section id="abstract-methods">
<h3>Abstract Methods<a class="headerlink" href="#abstract-methods" title="Permalink to this heading">#</a></h3>
<p>Example from autopilot subject class</p>
</section>
</section>
<section id="types-and-type-hints">
<h2>Types and Type Hints<a class="headerlink" href="#types-and-type-hints" title="Permalink to this heading">#</a></h2>
<p>Python isn’t a strongly typed language (ie. type hints are not <em>enforced</em>), but type hints let us make use of static
analysis tools that let us write code with more confidence and make our interfaces more explicit.</p>
<p>Say we do want to make a specific class for our prey capture data, maybe for the purpose of sharing it, or
maybe there is some analysis function that is truly unique to prey capture! who knows?</p>
<p>Example of making a function using the DLCData class.</p>
</section>
<section id="on-notebooks">
<h2>On Notebooks…<a class="headerlink" href="#on-notebooks" title="Permalink to this heading">#</a></h2>
<p>Notebooks are cool, but they should be used as <em>examples of how to use code</em> rather than contain any original code.</p>
<p>Notebooks can’t be reused, imported, or repurposed. They contain a ton of implicit dependencies on</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="interface"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>or maybe more appropriately as something that negotiates an interface, whatevs same difference to us here.</p>
</dd>
</dl>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./modularity"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Modularity</p>
      </div>
    </a>
    <a class="right-next"
       href="miniscope_io_refactoring.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Example: Miniscope IO</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interfaces-and-implementation">Interfaces and Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-from-pvp">Example from PVP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#functions">Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#worked-example">Worked Example</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#separate-i-o-from-analysis">Separate I/O from analysis</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#generalize-repeated-operations">Generalize Repeated Operations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#classes">Classes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inheritance">Inheritance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#abstract-methods">Abstract Methods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#types-and-type-hints">Types and Type Hints</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#on-notebooks">On Notebooks…</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jonny Saunders
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>